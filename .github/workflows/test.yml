name: Tests

on:
  pull_request:
  push:
    branches:
      - main
  workflow_call:  # Allow this workflow to be called by other workflows

# Testing Strategy:
# - For PRs: Tests run on the merge commit (PR branch merged with target)
#   This ensures the code will work after merging to main
# - For pushes to main: Tests run on the actual commit
# This prevents situations where tests pass on PR branch but fail after merge

# Concurrency: Cancel old test runs when new commits are pushed
# - For PRs: Each PR has its own concurrency group (test-pr-123)
# - For main: All pushes to main share one group (test-main)
# - Old runs are automatically cancelled when new ones start
concurrency:
  group: ${{ github.event_name == 'pull_request' && format('test-pr-{0}', github.event.pull_request.number) || 'test-main' }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # For PRs, test the merge commit (PR branch merged with target branch)
          # This ensures tests run on the actual code that will exist after merging
          ref: ${{ github.event_name == 'pull_request' && format('refs/pull/{0}/merge', github.event.pull_request.number) || github.ref }}

      - name: Display test context
        run: |
          echo "Testing context:"
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "  Event: Pull Request #${{ github.event.pull_request.number }}"
            echo "  Testing: MERGE COMMIT (PR + target branch)"
            echo "  Source: ${{ github.head_ref }}"
            echo "  Target: ${{ github.base_ref }}"
            echo "  Concurrency group: test-pr-${{ github.event.pull_request.number }}"
            echo "  This ensures tests pass AFTER merging to target branch"
            echo "  Old test runs for this PR are automatically cancelled"
          else
            echo "  Event: Push to ${{ github.ref_name }}"
            echo "  Testing: Actual commit"
            echo "  Concurrency group: test-main"
            echo "  Old test runs on main are automatically cancelled"
          fi
          echo "  Commit SHA: ${{ github.sha }}"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create .env file for tests
        working-directory: backend
        run: |
          cat > .env << EOF
          SECRET_KEY=test-secret-key-for-github-actions
          EXCHANGE_RATE_API_KEY=test-api-key
          OPENAI_API_KEY=test-openai-api-key
          DATABASE_URL=sqlite:///./test.db
          ALLOWED_ORIGINS=http://localhost:7000
          ALGORITHM=HS256
          ACCESS_TOKEN_EXPIRE_MINUTES=30
          REFRESH_TOKEN_EXPIRE_DAYS=7
          EOF

      - name: Run tests with coverage
        working-directory: backend
        run: |
          pytest tests/ --cov=app --cov-report=json --cov-report=term --cov-fail-under=90 --json-report --json-report-file=test-results.json

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: backend/coverage.json

      - name: Comment PR with backend coverage
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coverage = JSON.parse(fs.readFileSync('backend/coverage.json', 'utf8'));
            const totalCoverage = coverage.totals.percent_covered.toFixed(2);

            const comment = `### üß™ Backend Test Coverage: ${totalCoverage}%

            | Metric | Coverage |
            |--------|----------|
            | Statements | ${coverage.totals.percent_covered.toFixed(2)}% |
            | Lines Covered | ${coverage.totals.covered_lines} / ${coverage.totals.num_statements} |
            | Tests Passed | ‚úÖ All tests passed |

            ${totalCoverage >= 90 ? '‚úÖ Coverage requirement met (‚â•90%)' : '‚ùå Coverage below 90% requirement'}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # For PRs, test the merge commit (PR branch merged with target branch)
          # This ensures tests run on the actual code that will exist after merging
          ref: ${{ github.event_name == 'pull_request' && format('refs/pull/{0}/merge', github.event.pull_request.number) || github.ref }}

      - name: Display test context
        run: |
          echo "Testing context:"
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "  Event: Pull Request #${{ github.event.pull_request.number }}"
            echo "  Testing: MERGE COMMIT (PR + target branch)"
            echo "  Source: ${{ github.head_ref }}"
            echo "  Target: ${{ github.base_ref }}"
            echo "  Concurrency group: test-pr-${{ github.event.pull_request.number }}"
            echo "  This ensures tests pass AFTER merging to target branch"
            echo "  Old test runs for this PR are automatically cancelled"
          else
            echo "  Event: Push to ${{ github.ref_name }}"
            echo "  Testing: Actual commit"
            echo "  Concurrency group: test-main"
            echo "  Old test runs on main are automatically cancelled"
          fi
          echo "  Commit SHA: ${{ github.sha }}"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Run tests with coverage (90% threshold enforced)
        working-directory: frontend
        run: |
          npm run test:coverage -- --run

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage/coverage-summary.json

      - name: Comment PR with frontend coverage
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let comment = '### üé® Frontend Test Results\n\n';

            try {
              const coverage = JSON.parse(fs.readFileSync('frontend/coverage/coverage-summary.json', 'utf8'));
              const total = coverage.total;

              comment += `| Metric | Coverage |
              |--------|----------|
              | Statements | ${total.statements.pct.toFixed(2)}% (${total.statements.covered}/${total.statements.total}) |
              | Branches | ${total.branches.pct.toFixed(2)}% (${total.branches.covered}/${total.branches.total}) |
              | Functions | ${total.functions.pct.toFixed(2)}% (${total.functions.covered}/${total.functions.total}) |
              | Lines | ${total.lines.pct.toFixed(2)}% (${total.lines.covered}/${total.lines.total}) |
              `;
            } catch (error) {
              comment += '‚ö†Ô∏è Coverage report not available\n';
            }

            comment += '\n‚úÖ Frontend tests completed';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  notify-failure:
    name: Notify Test Failure
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    if: failure() && (github.event_name == 'push' && github.ref == 'refs/heads/main')

    steps:
      - name: Send Discord notification
        if: ${{ vars.DISCORD_WEBHOOK_URL }}
        run: |
          # Determine which tests failed
          BACKEND_STATUS="${{ needs.backend-tests.result }}"
          FRONTEND_STATUS="${{ needs.frontend-tests.result }}"

          FAILED_TESTS=""
          if [ "$BACKEND_STATUS" = "failure" ]; then
            FAILED_TESTS="Backend"
          fi
          if [ "$FRONTEND_STATUS" = "failure" ]; then
            if [ -n "$FAILED_TESTS" ]; then
              FAILED_TESTS="$FAILED_TESTS, Frontend"
            else
              FAILED_TESTS="Frontend"
            fi
          fi

          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"‚ùå Tests Failed\",
                \"description\": \"OnionTravel tests failed on main branch\",
                \"color\": 15158332,
                \"fields\": [
                  {\"name\": \"Failed Tests\", \"value\": \"$FAILED_TESTS\", \"inline\": false},
                  {\"name\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"inline\": true},
                  {\"name\": \"Commit\", \"value\": \"[\`${GITHUB_SHA:0:7}\`]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/commit/$GITHUB_SHA)\", \"inline\": true},
                  {\"name\": \"Author\", \"value\": \"${{ github.actor }}\", \"inline\": true},
                  {\"name\": \"Workflow Run\", \"value\": \"[View Logs]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)\", \"inline\": false},
                  {\"name\": \"Backend Status\", \"value\": \"$BACKEND_STATUS\", \"inline\": true},
                  {\"name\": \"Frontend Status\", \"value\": \"$FRONTEND_STATUS\", \"inline\": true}
                ],
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            "${{ vars.DISCORD_WEBHOOK_URL }}"
