# Nginx Configuration

This directory contains nginx configuration for OnionTravel deployment.

## Files

- **`oniontravel.conf.template`** - Template file with `${BASE_PATH}` placeholders
- **`oniontravel.conf`** - Generated file (DO NOT EDIT - auto-generated during deployment)
- **`nginx.conf`** - Old static config (deprecated, kept for reference)

## How It Works

The nginx configuration uses **environment variable substitution** to support flexible deployment paths:

1. **Template File** (`oniontravel.conf.template`):
   - Contains `${BASE_PATH}` placeholders throughout
   - Edit this file to make nginx configuration changes

2. **Generated File** (`oniontravel.conf`):
   - Auto-generated by `deploy.sh` using `envsubst`
   - Gitignored (not committed to repository)
   - Created during deployment with actual BASE_PATH value

3. **Deployment Process**:
   ```bash
   # In deploy.sh:
   export BASE_PATH=$(grep "^BASE_PATH=" backend/.env.example | cut -d '=' -f2)
   envsubst '${BASE_PATH}' < nginx/oniontravel.conf.template > nginx/oniontravel.conf
   # Then copy to production server
   ```

## Making Changes

### To modify nginx configuration:

1. Edit `nginx/oniontravel.conf.template`
2. Use `${BASE_PATH}` for the application path
3. Run `./deploy.sh` to deploy changes

**Example:**
```nginx
# Template syntax
location ${BASE_PATH}/api/ {
    rewrite ^${BASE_PATH}/api/(.*)$ /api/$1 break;
    proxy_pass http://127.0.0.1:7011;
}

# After envsubst with BASE_PATH=/OnionTravel
location /OnionTravel/api/ {
    rewrite ^/OnionTravel/api/(.*)$ /api/$1 break;
    proxy_pass http://127.0.0.1:7011;
}

# After envsubst with BASE_PATH=/dev-oniontravel
location /dev-oniontravel/api/ {
    rewrite ^/dev-oniontravel/api/(.*)$ /api/$1 break;
    proxy_pass http://127.0.0.1:7011;
}
```

## Testing Locally

Test template substitution before deploying:

```bash
# Test with production path
export BASE_PATH="/OnionTravel"
envsubst '${BASE_PATH}' < nginx/oniontravel.conf.template > /tmp/test-nginx.conf
cat /tmp/test-nginx.conf

# Test with dev path
export BASE_PATH="/dev-oniontravel"
envsubst '${BASE_PATH}' < nginx/oniontravel.conf.template > /tmp/test-nginx.conf
cat /tmp/test-nginx.conf
```

## Changing Deployment Path

To deploy OnionTravel at a different path (e.g., `/dev-oniontravel` for development):

1. Edit `backend/.env.example`:
   ```bash
   BASE_PATH=/dev-oniontravel
   ```

2. Edit `frontend/.env.example`:
   ```bash
   VITE_BASE_PATH=/dev-oniontravel
   ```

3. Run deployment:
   ```bash
   ./deploy.sh
   ```

The script will automatically:
- Generate nginx config with `/dev-oniontravel` path
- Build Docker containers with correct BASE_PATH
- Deploy to production server

Application will be available at: `https://jola209.mikrus.xyz:30209/dev-oniontravel`

## Environment Variable Substitution

`envsubst` replaces **only** variables specified in the variable list:

```bash
envsubst '${BASE_PATH}' < template > output
```

This ensures nginx variables like `$host`, `$request_uri`, etc. are **not** replaced (they stay as `$host`, not expanded).

In the template, nginx variables use `\$` to prevent expansion:
```nginx
# Will NOT be replaced by envsubst (stays as $host)
proxy_set_header Host \$host;

# WILL be replaced by envsubst
location ${BASE_PATH}/api/ {
```
